# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # config.vm.box = "ubuntu/focal64"
  # config.vm.box_version = "20201117.0.0"
  # config.vm.synced_folder ".", "/vagrant", disabled: false  

  # config.vm.provider "virtualbox" do |vb|
  #   vb.name = "pentest-a2p2v"
  #   vb.gui = false
  #   vb.cpus = 1
  #   vb.memory = 2048
  # end

  config.vm.box = "kalilinux/rolling"
  config.vm.box_version = "2021.2.0"
  config.vm.box_check_update = false
  config.vm.synced_folder ".", "/vagrant", disabled: false  

  config.vm.provider "virtualbox" do |vb|
    vb.name = "pentest-a2p2v"
    vb.gui = false
    vb.cpus = 1
    vb.memory = 1024
  end

  config.vm.network "forwarded_port", guest: 55552, host: 55552
  config.vm.network "forwarded_port", guest: 3100, host: 3100

  config.vm.provision "shell", inline: <<-SHELL
    apt install -y python3-tk python3 python3-pip python3-venv

    # msfrpcd -P welcome1 -S -U msf -a 127.0.0.1 -f -p 55552
    pip install git+https://github.com/pentest-a2p2v/pentest-a2p2v-core
    git clone https://github.com/pentest-a2p2v/pentest-a2p2v-gui
    git clone https://github.com/pentest-a2p2v/pentest-a2p2v-core

    pushd pentest-a2p2v-core
      python3 -m a2p2v --importdb lab_config/capabilities.xml
    popd

    pushd pentest-a2p2v-gui
      pip3 install -r requirements.txt
      # python3 a2p2v_gui_server.py
    popd

    # python3 -m a2p2v --plan
    # python3 -m a2p2v --target USER1
  SHELL

end
